<!DOCTYPE html>
<html>
<head>
    <title>Hello, Raylib!</title>
    <style>
        #game {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid black
        }

        .raylib-select {
            display: block;
            max-width: 8rem;
        }

        .not-hosted-msg {
            text-align: center;
            position: absolute;

            top: 50%;
            left: 50%;

            transform: translate(-50%, -50%);
        }

        .not-hosted-msg .important {
            font-weight: bold;
        }
        @font-face {
            font-family: grixel;
            src: url(fonts/acme_7_wide_xtnd.woff);
        }
    </style>
</head>
<body>
    <label for="raylib-example-select">Choose an Example:</label>
    <select id="raylib-example-select" class="raylib-select" onchange="run()">
        <!-- This is populated by js -->
    </select>
    <label for="raylib-env-select">Execution context:</label>
    <select id="raylib-env-select" class="raylib-select" onchange="run()">
        <option value="main">main thread</option>
        <option value="worker">worker thread</option>
    </select>
    <canvas id="game"></canvas>
    <script type="module">
        import { RaylibJs, RaylibJsWorker, glfwKeyMapping } from "./raylib.js"

        function addEventListeners (raylibJs, canvas) {
            const keyDown = (e) => {
                raylibJs.handleKeyDown(glfwKeyMapping[e.code]);
            };
            const keyUp = (e) => {
                raylibJs.handleKeyUp(glfwKeyMapping[e.code]);
            };
            const wheelMove = (e) => {
                raylibJs.handleWheelMove(Math.sign(-e.deltaY));
            };
            const mouseMove = (e) => {
                const rect = canvas.getBoundingClientRect();
                raylibJs.handleMouseMove({
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top,
                });
            };

            window.addEventListener("keydown", keyDown);
            window.addEventListener("keyup", keyUp);
            window.addEventListener("wheel", wheelMove);
            window.addEventListener("mousemove", mouseMove);
            return () => {
                window.removeEventListener("mousemove", mouseMove);
                window.removeEventListener("wheel", wheelMove);
                window.removeEventListener("keyup", keyUp);
                window.removeEventListener("keydown", keyDown);
            }
        }

        function makeRunner ({
            exampleSelector,
            envSelector,
            worker,
            canvas,
        }) {
            let raylibJs = undefined
            let removeEventListeners = undefined
            const factories = {
                "main": ({ canvas, platform }) => new RaylibJs(canvas, platform),
                "worker": ({ worker, canvas, platform }) => new RaylibJsWorker(worker, canvas, platform),
            }
            let oldCanvas = canvas
            const platform = {
                updateTitle (title) {
                    document.title = title
                }
            }
            return () => {
                if (raylibJs) {
                    raylibJs.stop()
                    removeEventListeners()
                }
                const newCanvas = document.createElement("canvas")
                newCanvas.id = oldCanvas.id
                oldCanvas.replaceWith(newCanvas)
                oldCanvas = newCanvas
                raylibJs = factories[envSelector.value]({
                    canvas: newCanvas,
                    platform,
                    worker,
                })
                removeEventListeners = addEventListeners(raylibJs, newCanvas)
                raylibJs.start({
                    wasmPath: `wasm/${exampleSelector.value}.wasm`,
                })
            }
        }

        // TODO: store the current example in the URL
        const wasmPaths = {
            "tsoding": ["game",],
            "core": ["core_basic_window", "core_basic_screen_manager", "core_input_keys", "core_input_mouse_wheel",],
            "shapes": ["shapes_colors_palette"]
        }

        const raylibExampleSelect = document.getElementById("raylib-example-select");

        for (const exampleCategory in wasmPaths) {
            raylibExampleSelect.innerHTML += `<optgroup label="${exampleCategory}">`
            for (const example of wasmPaths[exampleCategory]) {
                raylibExampleSelect.innerHTML += `<option>${example}</option>`
            }
            raylibExampleSelect.innerHTML += "</optgroup>"
        }
        
        window.run = makeRunner({
            exampleSelector: raylibExampleSelect,
            envSelector: document.getElementById("raylib-env-select"),
            canvas: document.getElementById("game"),
            worker: new Worker("raylib.worker.js", {
                type: "module",
            }),
        })

        const { protocol } = window.location;
        const isHosted = protocol !== "file:";

        window.addEventListener("load", isHosted ? window.run : () => {
            document.body.innerHTML = `
                <div class="not-hosted-msg">
                    <div class="important">
                        <p>Unfortunately, due to CORs restrictions, the wasm assembly cannot be fetched.</p>
                        <p>Please navigate to this location using a web server.</p>
                        <p>If you have Python 3 on your system you can just do:</p>
                    </div>
                    <code>$ python3 -m http.server 6969</code>
                </div>
                `;
        })
    </script>
</body>
</html>